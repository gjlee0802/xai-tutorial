# Counterfactual Explanations 반사실적 설명
* https://christophm.github.io/interpretable-ml-book/counterfactual.html
* https://eair.tistory.com/32

반사실적 설명은 인과적 상황을 "X가 벌어지지 않았다면 Y는 발생하지 않았을 것이다"라는 방식으로 설명합니다.

예측에 대한 반사실적 설명은 예측을 미리 정의된 출력으로 바꾸는 특성값의 가장 작은 변화를 설명합니다.


## Model-agnostic vs Model-specific
모델 불특정법(Model-agnostic)과 모델 특정법(Model-specific)의 반사실적 설명 방법이 모두 있지만, 여기서는 모델 입력과 출력으로만 작동하는 모델 불특정법에 중점을 두겠습니다(특정 모델의 내부 구조는 제외).

## The issue of multiple truths
각각의 반사실적 설명은 어떻게 어떤 결과가 나왔는지에 대한 다른 "이야기"를 언급합니다. 한 반사실적 설명은 특성 A를 변경한다고 말할 수 있고, 다른 반사실적 설명은 A를 동일하게 하지만 특성 B를 변경하라고 말할 수 있는데, 이 증언은 서로 모순됩니다. 다중 진실에 대한 해당 문제는 모든 반사실적 설명을 보고하거나 반사실적 설명을 평가하고 가장 적합한 것을 선택하는 기준(Criteria)을 갖는 방법으로 해결할 수 있습니다.

## Criterion to evaluate counterfactuals and select the best one
좋은 반사실적 설명에 대한 기준
1. 반사실적 인스턴스가 미리 정의된 예측을 가능한 가깝게 생성한다는 것입니다.
2. 특성값에 관한 인스턴스와 가능한 한 유사해야 한다는 것입니다.
    반사실적 설명은 원래 인스턴스와 가까워야 할 뿐만 아니라 가능한 한 특성을 최대한 변경하지 말아야 합니다.
3. 여러 가지 다양한 반사실적 설명을 생성하는 것이 바람직합니다.
4. 반사실적 인스턴스에는 가능한 특성값이 있어야 한다는 것입니다.

## Generating Counterfactual Explanations
반사실적 설명을 생성하는 단순하고 순수한 접근 방식은 시행착오(Trial and error)를 통해 탐색하는 방법입니다. 
 
이 접근법에는 관심있는 인스턴스의 특성값을 임의로 변경하고 원하는 출력이 예측될 때 중지하는 방법이 포함됩니다. 안나가 임대료를 더 받을 수 있는 아파트의 조건을 찾으려고 했던 예처럼 말이지요. 그러나 시행착오보다 더 나은 접근법이 있습니다. 

먼저 위에서 언급한 기준에 따라 손실 함수(Loss function)를 정의합니다. 이 손실은 관심있는 인스턴스, 반사실적 설명, 그리고 원하는 (반사실적 설명의) 결과를 입력으로 합니다. 
그런 다음 최적화 알고리즘을 사용하여 이러한 손실을 최소화하는 반사실적 설명을 찾을 수 있습니다. 많은 방법들이 이러한 방식으로 진행되지만 손실 함수와 최적화 방법에 대한 정의는 다릅니다.

위에서 언급한 것들 중에서 우리는 두 가지에 집중하고자 합니다. 

* 첫번째는 반사실적 설명을 하나의 해석 수단으로서 소개한 Wachter et al.(2018)의 사례와, 
* 위에서 언급하였던 모든 네 가지 기준을 고려한 Dandl et al.(2020)의 사례입니다.


### Method by Wachter et al. 

제안된 방법은 몇 가지 단점이 있습니다. 

첫 번째와 두 번째 기준만 고려하며 마지막 두 가지 기준("특성값 변경 및 가능한 특성값 몇 개만 있는 반사실적 설명 생성") d는 10개의 특성을 1개 증가시키는 것과 동일한 거리를 x에 제공하기 때문에 희소 솔루션을 선호하지 않습니다. 비현실적인 특성 조합은 불이익을 받지 않습니다.

이 방법에서는 여러 단계의 카테고리형 특성을 잘 처리하지 못합니다. 이 방법의 저자는 카테고리형 특성의 특성값 조합에 대해 이 방법을 별도로 수행할 것을 제안했지만, 값이 많은 카테고리형 특성이 여러 개일 경우 조합 변수가 폭발적으로 많아질 수 있습니다. 예를 들어 고유 단계가 10개인 6개의 카테고리형 특성은 백만 번의 수행을 의미합니다.

이러한 이슈를 극복한 또다른 접근법에 대해 보도록 합시다.

### Method by Dandl et al. 
Dandl et al.은 4가지 목표 손실을 동시에 최소화할 것을 제안합니다.

Nondominated Sorting Genetic Algorithm 또는 short NSGA-II를 사용합니다.

#### NSGA-II
첫 번째 세대에서는 설명할 인스턴스 x와 비교하여 일부 특성을 임의로 변경하여 반사실적 설명의 후보 그룹이 초기화됩니다. 위의 신용대출에 대한 예에 따르면, 한 가지 반사실적 설명 요인은 소득을 €30,000까지 증가시킬 것을 제안할 수 있고, 다른 한 요인은 지난 5년 동안 채무불이행이 없고 연령이 10세까지 감소할 것을 제안할 수 있습니다. 다른 모든 특성값은 x 값과 동일하며, 각 후보는 위의 네 가지 객관적 함수를 사용하여 평가됩니다. 그 중에서, 우리는 더 적합한 후보들이 선택될 가능성이 높은 몇몇 후보들을 무작위로 선정합니다. 후보자는 수치 특성값을 평균으로 하거나 카테고리 특성을 교차하여 자신과 유사한 자식을 생산하기 위해 쌍으로 재조합됩니다. 또한, 전체 특성 공간을 탐색하기 위해 하위의 특성값을 약간 변형합니다.

두 결과 그룹 중 하나는 부모 그룹이고 다른 하나는 자식 그룹이며, 우리는 **두 개의 정렬 알고리즘**을 사용하여 가장 좋은 절반만을 원합니다. 
* 비지배적(Nondominated) 정렬 알고리즘은 목표 값에 따라 후보들을 정렬합니다. 
* 후보가 동등하게 우수하면 밀집도 거리(Crowding distance) 정렬 알고리즘은 후보의 다양성에 따라 후보를 정렬합니다.

두 정렬 알고리즘의 순위를 고려할 때, 우리는 후보 중 가장 유망하거나 가장 다양한 절반을 선택합니다. 우리는 다음 세대를 위해 이 세트를 사용하고 선택, 재조합, 돌연변이(mutation) 과정부터 다시 시작합니다. 이러한 단계를 반복함으로써 우리는 낮은 객관적 가치를 지닌 다양한 유망한 후보들에게 접근하기를 원합니다. 이 집합에서 우리는 가장 만족스러운 것을 선택할 수 있고, 또는 어떤 특성과 얼마나 자주 변했는지를 강조함으로써 모든 반사실적 설명에 대한 요약을 제공할 수 있습니다.

